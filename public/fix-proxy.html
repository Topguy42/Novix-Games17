<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fixing proxy...</title>

    <style>
      @font-face {
        font-family: Inter;
        font-style: normal;
        font-weight: 400;
        src: url('images/Inter-Regular.woff2') format('woff2');
      }

      * {
        box-sizing: border-box;
      }

      body {
        align-items: center;
        animation: bgShift 20s ease-in-out infinite;
        background: radial-gradient(circle at center, #001b33 0%, #000814 100%);
        background-size: 200% 200%;
        color: #d0eaff;
        display: flex;
        font-family: Inter, Arial, Helvetica, sans-serif;
        height: 100vh;
        justify-content: center;
        margin: 0;
        overflow: hidden;
        padding: 0;
        position: relative;
        width: 100vw;
      }

      @keyframes bgShift {
        0% {
          background-position: 0% 50%;
        }

        50% {
          background-position: 100% 50%;
        }

        100% {
          background-position: 0% 50%;
        }
      }

      #main {
        align-items: center;
        display: flex;
        flex-direction: column;
        text-align: center;
        z-index: 2;
      }

      .spinner {
        filter: drop-shadow(0 0 12px #00bfff);
        height: 140px;
        margin-bottom: 20px;
        position: relative;
        width: 140px;
      }

      .spinner-circle {
        animation: spin 1.8s linear infinite;
        border: 8px solid transparent;
        border-radius: 50%;
        position: absolute;
      }

      .spinner-circle:nth-child(1) {
        border-left-color: #0074d9;
        border-top-color: #00bfff;
        height: 100%;
        width: 100%;
      }

      .spinner-circle:nth-child(2) {
        animation-direction: reverse;
        animation-duration: 2.5s;
        border-left-color: #05a;
        border-top-color: #036;
        height: 72%;
        left: 14%;
        top: 14%;
        width: 72%;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }

        to {
          transform: rotate(360deg);
        }
      }

      #glitch-text {
        animation:
          glowPulse 2s ease-in-out infinite,
          bounce 3s ease-in-out infinite;
        color: #d0eaff;
        font-size: 36px;
        font-weight: 700;
        letter-spacing: 4px;
        margin-top: 30px;
        text-shadow:
          0 0 10px #00bfff,
          0 0 20px #0074d9,
          0 0 30px #05a,
          0 0 50px #036;
        text-transform: uppercase;
      }

      @keyframes glowPulse {
        0% {
          text-shadow:
            0 0 6px #00bfff,
            0 0 12px #0074d9,
            0 0 18px #05a,
            0 0 30px #036;
        }

        50% {
          text-shadow:
            0 0 20px #00d5ff,
            0 0 30px #0094ff,
            0 0 40px #07c,
            0 0 60px #048;
        }

        100% {
          text-shadow:
            0 0 6px #00bfff,
            0 0 12px #0074d9,
            0 0 18px #05a,
            0 0 30px #036;
        }
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }

        50% {
          transform: translateY(-5px);
        }
      }

      .shadow-layer {
        background: radial-gradient(ellipse at center, rgb(0 10 30 / 60%), rgb(0 0 0 / 95%));
        height: 100vh;
        position: absolute;
        width: 100vw;
        z-index: 0;
      }

      .stars {
        background: transparent url('/storage/images/stardust.png') repeat;
        height: 100%;
        opacity: 0.08;
        position: absolute;
        width: 100%;
        z-index: 0;
      }
    </style>
  </head>

  <body>
    <div class="stars"></div>
    <div class="shadow-layer"></div>

    <div id="main">
      <div class="spinner">
        <div class="spinner-circle"></div>
        <div class="spinner-circle"></div>
      </div>
      <p id="glitch-text">LOADING</p>
    </div>

    <script>
      const target = document.getElementById('glitch-text');
      const original = target.textContent;
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let iterations = 0;

      const glitchInterval = setInterval(() => {
        let displayed = '';
        for (let i = 0; i < original.length; i++) {
          if (i < iterations) {
            displayed += original[i];
          } else if (original[i] === ' ') {
            displayed += ' ';
          } else {
            displayed += chars[Math.floor(Math.random() * chars.length)];
          }
        }
        target.textContent = displayed.toUpperCase();
        iterations += 0.5;
        if (iterations >= original.length) {
          clearInterval(glitchInterval);
          target.textContent = original.toUpperCase();
        }
      }, 50);
    </script>
    <script>
      if (window.location.search.includes('retry')) {
        navigator.serviceWorker.getRegistrations().then((registrations) => {
          // Unregister all service workers
          const unregisterPromises = registrations.map((reg) =>
            reg.unregister().then((success) => {
              console.log(`Service Worker unregistered: ${success}`);
            })
          );

          // After all are unregistered, delete the database
          Promise.all(unregisterPromises).then(() => {
            const dbName = '$scramjet';
            const request = indexedDB.deleteDatabase(dbName);

            request.onsuccess = () => {
              console.log(`Deleted IndexedDB: ${dbName}`);
            };
            request.onerror = () => {
              console.error(`Failed to delete IndexedDB: ${dbName}`);
              deletionfailed = true;
            };
            request.onblocked = () => {
              console.warn(`Delete blocked for IndexedDB: ${dbName}`);
              deletionfailed = true;
            };
          });
        });
        if (localStorage.getItem('bare-mux-path') !== '/baremux/worker.js') {
          localStorage.setItem('bare-mux-path', '/baremux/worker.js');
        }
        if (deletionfailed === true) {
          window.location.href = 'fix-proxy.html?retry=true';
        }
      } else {
        const dbName = '$scramjet';
        const request = indexedDB.deleteDatabase(dbName);
        request.onsuccess = () => {
          console.log(`Deleted IndexedDB: ${dbName}`);
        };
        request.onerror = () => {
          console.error(`Failed to delete IndexedDB: ${dbName}`);
        };
        request.onblocked = () => {
          console.warn(`Delete blocked for IndexedDB: ${dbName}`);
        };
        window.location.href = '/';
      }
    </script>
  </body>
</html>
